---
tags:
  - Flagger
  - Progressive Delivery
  - Istio
  - Service Mesh
---
# Flagger Istio Integration

This article documents notes and additional explanations made while following the Flagger-provided [Istio Canary Deployments](https://docs.flagger.app/main/tutorials/istio-progressive-delivery) tutorial.



![](./assets/istio-demo.excalidraw.svg)

When you are trying to specify a `Canary` resource for flagger, there are several fields that are so confusing that it is hard to understand what they do and how to set them up properly. Below is a list of such fields with explanations.

## Public Gateway

```yaml title="public-gateway.yaml"
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: public-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "*"
```

This `public-gateway` Istio Gateway defines an HTTP ingress entry on port 80, allowing requests with any Host header to enter, with traffic being received by the `istio-ingressgateway` into the Kubernetes Cluster.


## Canary Spec Fields

```yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: podinfo
  namespace: test
spec:
  # deployment reference
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: podinfo
  # HPA reference (optional)
  autoscalerRef:
    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    name: podinfo
  # the maximum time in seconds for the canary deployment
  # to make progress before it is rollback (default 600s)
  progressDeadlineSeconds: 600
  service:
    # Istio gateways (optional)
    gateways:
      - istio-system/public-gateway
    # Istio virtual service host names (optional)
    hosts:
      - app.example.com
    # service port number
    port: 9898
    # container port number or name (optional)
    targetPort: 9898
    # Istio traffic policy (optional)
    trafficPolicy:
      tls:
        # use ISTIO_MUTUAL when mTLS is enabled
        mode: DISABLE
    # Istio retry policy (optional)
    retries:
      attempts: 3
      perTryTimeout: 1s
      retryOn: "gateway-error,connect-failure,refused-stream"
  analysis:
    # schedule interval (default 60s)
    interval: 1m
    # max number of failed metric checks before rollback
    threshold: 3
    # max traffic percentage routed to canary
    # percentage (0-100)
    maxWeight: 50
    # canary increment step
    # percentage (0-100)
    stepWeight: 10
    metrics:
      - name: request-success-rate
        interval: 1m
        # minimum req success rate (non 5xx responses)
        # percentage (0-100)
        thresholdRange:
          min: 99
      - name: request-duration
        interval: 30s
        # maximum req duration P99
        # milliseconds
        thresholdRange:
          max: 500
    # testing (optional)
    webhooks:
      - name: acceptance-test
        type: pre-rollout
        url: http://flagger-loadtester.test/
        timeout: 30s
        metadata:
          type: bash
          cmd: "curl -sd 'test' http://podinfo-canary:9898/token | grep token"
      - name: load-test
        type: rollout
        url: http://flagger-loadtester.test/
        timeout: 5s
        metadata:
          cmd: "hey -z 1m -q 10 -c 2 http://podinfo-canary.test:9898/"
```

### Istio Gateway and VirtualService Hosts

```yaml
...
kind: Canary
...
spec:
  ...
  service:
    # Istio gateways (optional)
    gateways:
      - istio-system/public-gateway
    # Istio virtual service host names (optional)
    hosts:
      - app.example.com
    # service port number
    port: 9898
    # container port number or name (optional)
    targetPort: 9898
    ...
  ...
...
```

The `spec.service.gateways` in the Flagger `Canary` CR configures **which Istio Gateways the Istio `VirtualService` generated by Flagger should apply traffic rules to.** This is written into the `VirtualService`'s `spec.gateways`, meaning **only traffic passing through these Gateways will be subject to this `VirtualService`'s routing rules, which is traffic splitting for canary deployments**.

The `spec.service.hosts` in the Flagger `Canary` CR configures **which Host headers the Istio `VirtualService` generated by Flagger should handle.** This is written into the `VirtualService`'s `spec.hosts`, meaning **only traffic with Host headers matching these host names will be subject to this `VirtualService`'s routing rules.**


The `spec.service.port` and `spec.service.targetPort` in the Flagger `Canary` CR will be used in several different places, depending on the context:

Flagger will automatically create or take over Kubernetes Services for traffic routing. The `spec.service.port` and `spec.service.targetPort` in the Flagger `Canary` CR will be used to configure the ports of these Services.

Specifically, Flagger will create three Services for you:

- `<service-name>`
- `<service-name>-primary`
- `<service-name>-canary`

The `spec.service.port` in the Flagger `Canary` CR will become the `spec.ports[].port` of these Services, while `spec.service.targetPort` will become the `spec.ports[].targetPort` of these Services.

### Progress Deadline Seconds and Analysis Interval

```yaml
...
kind: Canary
...
spec:
  progressDeadlineSeconds: 600
  ...
  analysis:
    interval: 1m
```

`spec.progressDeadlineSeconds` is a Kubernetes `Deployment` spec field that defines **the maximum time (in seconds) the controller waits for a deployment to make progress** (e.g., new pods becoming ready) **before marking it as failed due to stalled progress**, defaulting to 600 seconds (10 minutes) and triggering a `ProgressDeadlineExceeded` condition in the deployment status.

`spec.analysis.interval` defines **how often Flagger performs analysis during the canary deployment process**, defaulting to 1 minute. This interval determines **how frequently Flagger checks the metrics and logs** to evaluate the health and performance of the canary version compared to the stable version.

### Metrics Analysis

```yaml
...
spec:
  ...
  analysis:
    # schedule interval (default 60s)
    interval: 1m
    # canary increment step
    # percentage (0-100)
    stepWeight: 10
    # max traffic percentage routed to canary
    # percentage (0-100)
    maxWeight: 50
    # max number of failed metric checks before rollback
    threshold: 3
```

Metrics are checked once per minute (`interval: 1m`), with each check increasing canary traffic by 10% (`stepWeight: 10`), up to a maximum of 50% traffic to canary (`maxWeight: 50`). If 3 checks fail (`threshold: 3`), a rollback occurs.

```yaml
spec:
  ...
  analysis:
    ...
    metrics:
      - name: request-success-rate
        interval: 1m
        # minimum req success rate (non 5xx responses)
        # percentage (0-100)
        thresholdRange:
          min: 99
      - name: request-duration
        interval: 30s
        # maximum req duration P99
        # milliseconds
        thresholdRange:
          max: 500
```

Each metric check evaluates two metrics:

1. `request-success-rate`: Checked once per minute, requiring a success rate of at least 99% (non-5xx responses).
2. `request-duration`: Checked every 30 seconds, requiring P99 request duration not to exceed 500 milliseconds.

It's worth noting that `request-success-rate` and `request-duration` are predefined metric names in Flagger, and Flagger automatically calculates the corresponding metric values based on these names. Specifically, Flagger uses Prometheus queries to calculate these metrics.

The Prometheus query for `request-success-rate` is as follows:

```promql
sum(
    rate(
        istio_requests_total{
          reporter="destination",
          destination_workload_namespace=~"{{ namespace }}",
          destination_workload=~"{{ target }}",
          response_code!~"5.*"
        }[{{ interval }}]
    )
)
/
sum(
    rate(
        istio_requests_total{
          reporter="destination",
          destination_workload_namespace=~"{{ namespace }}",
          destination_workload=~"{{ target }}"
        }[{{ interval }}]
    )
)
```

The Prometheus query for `request-duration` is as follows:

```promql
histogram_quantile(0.99,
  sum(
    irate(
      istio_request_duration_milliseconds_bucket{
        reporter="destination",
        destination_workload=~"{{ target }}",
        destination_workload_namespace=~"{{ namespace }}"
      }[{{ interval }}]
    )
  ) by (le)
)
```

During the progressive delivery process, Flagger divides each gradual rollout into multiple phases, such as:

- `confirm-rollout` hooks are executed before scaling up the canary deployment and can be used for manual approval.
- `pre-rollout` hooks are executed before routing traffic to canary.
- `rollout hooks` are executed during the analysis on each iteration before the metric checks.
- `confirm-traffic-increase` hooks are executed right before the weight on the canary is increased.
- `confirm-promotion` hooks are executed before the promotion step.
- `post-rollout` hooks are executed after the canary has been promoted or rolled back.

Before the entire rollout begins, Flagger executes the `acceptance-test` webhook, calling the URL `http://flagger-loadtester.test/` and requesting the flagger-loadtester service to execute `curl` to call the `podinfo-canary:9898/token` endpoint, checking whether the response contains the string `token`. If it does, the test passes and traffic routing can proceed to the next step.

During the rollout loop, Flagger executes the `load-test` webhook, calling the URL `http://flagger-loadtester.test/` and requesting the flagger-loadtester service to run the `hey` tool to perform load testing against the `podinfo-canary.test:9898/` endpoint, simulating a rate of 10 requests per second for 1 minute with 2 concurrent requests. Through this load testing, the canary version's performance under actual traffic can be observed.

```yaml
spec:
  ...
  analysis:
    ...
    # testing (optional)
    webhooks:
      - name: acceptance-test
        type: pre-rollout
        url: http://flagger-loadtester.test/
        timeout: 30s
        metadata:
          type: bash
          cmd: "curl -sd 'test' http://podinfo-canary:9898/token | grep token"
      - name: load-test
        type: rollout
        url: http://flagger-loadtester.test/
        timeout: 5s
        metadata:
          cmd: "hey -z 1m -q 10 -c 2 http://podinfo-canary.test:9898/"
```